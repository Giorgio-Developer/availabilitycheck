<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizzatore Calendari - Admin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
        }
        .calendar-container {
            margin-top: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem;
        }
        .calendar-title {
            color: #03a9f4;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
        }
        .room-section {
            background: linear-gradient(145deg, #1f1f1f, #252525);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2.5rem;
            border: 1px solid #444;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .room-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        .room-title {
            color: #03a9f4;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        .room-title i {
            margin-right: 0.5rem;
        }
        .calendar-legend {
            background-color: #2a2a2a;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 0.75rem;
        }
        .calendar1-color { background-color: #ff6b6b; }
        .calendar2-color { background-color: #4ecdc4; }
        .overlap-color { background-color: #ffd93d; }

        /* Custom Calendar Styles */
        .custom-calendar {
            background-color: #1f1f1f;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            margin-bottom: 1rem;
        }

        .calendar-header {
            background: linear-gradient(135deg, #2a2a2a, #333);
            padding: 1.25rem;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid #444;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }

        .nav-button {
            background: linear-gradient(135deg, #03a9f4, #0288d1);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(3, 169, 244, 0.3);
        }

        .nav-button:hover {
            background: linear-gradient(135deg, #0288d1, #0277bd);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(3, 169, 244, 0.4);
        }

        .nav-button:active {
            transform: translateY(0);
        }

        .month-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #03a9f4;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #444;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .day-header {
            background: linear-gradient(135deg, #03a9f4, #0288d1);
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.95rem;
            color: white;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
        }
        .day-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00bcd4, #03a9f4, #0288d1);
        }

        .day-cell {
            background-color: #1f1f1f;
            min-height: 100px;
            padding: 0.75rem 0.5rem;
            position: relative;
            border: none;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .day-cell:hover {
            background-color: #262626;
            transform: scale(1.02);
            z-index: 2;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .day-cell.today {
            background: linear-gradient(135deg, #1b4332, #2d5016);
            border: 2px solid #4caf50;
            box-shadow: inset 0 2px 4px rgba(76, 175, 80, 0.2);
        }
        .day-cell.today .day-number {
            color: #4caf50;
            font-weight: 800;
        }

        .day-cell.has-events {
            border-left: 3px solid #03a9f4;
        }

        .day-number {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-other-month {
            opacity: 0.4;
        }

        .day-other-month .day-number {
            color: #666;
        }

        .events-count {
            background: linear-gradient(135deg, #03a9f4, #0288d1);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(3, 169, 244, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .event-indicator {
            width: 100%;
            height: 20px;
            margin-bottom: 3px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-align: left;
            color: white;
            line-height: 20px;
            padding: 0 6px 0 18px;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .event-indicator:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 10;
            position: relative;
        }

        .event-calendar1 {
            background: linear-gradient(135deg, #ff6b6b, #e55a5a);
            border-left-color: #ff5252;
        }
        .event-calendar1::before {
            content: '‚óè';
            position: absolute;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .event-calendar2 {
            background: linear-gradient(135deg, #4ecdc4, #45b7b8);
            border-left-color: #26a69a;
        }
        .event-calendar2::before {
            content: '‚ñ≤';
            position: absolute;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .event-overlap {
            background: linear-gradient(135deg, #ffd93d, #f6c23e);
            color: #000;
            font-weight: 700;
            border-left-color: #ffcc02;
            animation: pulse-warning 2s infinite;
        }
        .event-overlap::before {
            content: '‚ö†';
            position: absolute;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #d84315;
        }
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .event-more {
            background: linear-gradient(135deg, #666, #555);
            color: #ccc;
            text-align: center;
            font-size: 0.65rem;
            height: 16px;
            line-height: 16px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 2px;
            font-weight: 600;
            border-left: 2px solid #999;
        }

        .event-more:hover {
            background-color: #777;
        }

        /* Enhanced Tooltip */
        .tooltip {
            position: fixed;
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            z-index: 2000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border: 1px solid #555;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            max-width: 280px;
            line-height: 1.4;
        }
        .tooltip::before {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #2a2a2a;
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
        .tooltip-title {
            font-weight: 700;
            color: #03a9f4;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .tooltip-source {
            color: #ffd93d;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .tooltip-time {
            color: #ccc;
            font-size: 0.8rem;
        }

        .back-button {
            background-color: #1f1f1f;
            border-color: #03a9f4;
            color: #03a9f4;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            text-decoration: none;
            padding: 0.5rem 1rem;
            margin-bottom: 2rem;
            width: fit-content;
        }
        .back-button:hover {
            background-color: #0288d1;
            color: #ffffff;
            text-decoration: none;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        .error {
            background-color: #d32f2f;
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .btn-agenda {
            transition: all 0.2s ease !important;
        }
        .btn-agenda:hover {
            transform: translateY(-1px) !important;
        }
        .btn-agenda:active {
            transform: translateY(0) !important;
        }
        .event-source {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .calendar-container {
                padding: 0 0.5rem;
                margin-top: 1rem;
            }
            .room-section {
                padding: 1.5rem 1rem;
                margin-bottom: 1.5rem;
            }
            .room-title {
                font-size: 1.1rem;
                text-align: center;
                margin-bottom: 1.5rem;
            }
            .calendar-grid {
                font-size: 0.8rem;
            }
            .day-cell {
                min-height: 70px;
                padding: 0.5rem 0.25rem;
            }
            .day-number {
                font-size: 0.85rem;
                margin-bottom: 0.25rem;
            }
            .event-indicator {
                height: 16px;
                font-size: 0.65rem;
                line-height: 16px;
                padding: 0 4px 0 14px;
                margin-bottom: 2px;
            }
            .event-calendar1::before,
            .event-calendar2::before,
            .event-overlap::before {
                font-size: 0.5rem;
                left: 2px;
            }
            .events-count {
                width: 16px;
                height: 16px;
                font-size: 0.65rem;
            }
            .tooltip {
                max-width: 250px;
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            .nav-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            .month-title {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .calendar-title {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            .day-cell {
                min-height: 60px;
            }
            .day-number {
                font-size: 0.8rem;
            }
            .event-indicator {
                height: 14px;
                font-size: 0.6rem;
                line-height: 14px;
            }
            .tooltip {
                max-width: 200px;
                font-size: 0.75rem;
            }
            .legend-item {
                margin-bottom: 0.75rem;
                justify-content: center;
            }
            .legend-color {
                width: 16px;
                height: 16px;
            }
        }

        /* Accessibility Improvements */
        .event-indicator:focus {
            outline: 2px solid #03a9f4;
            outline-offset: 2px;
        }
        .day-cell:focus {
            outline: 2px solid #4caf50;
            outline-offset: -2px;
        }
        .nav-button:focus {
            outline: 2px solid #03a9f4;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .room-section {
                border: 2px solid #fff;
            }
            .event-indicator {
                border: 1px solid #fff;
            }
            .day-cell {
                border: 1px solid #666;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .tooltip {
                transition: none;
            }
            .event-indicator:hover {
                transform: none;
            }
            .day-cell:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid calendar-container">
        <a href="/admin/dashboard" class="back-button">
            <i class="material-icons" style="margin-right: 0.5rem;">arrow_back</i>
            Torna alla Dashboard
        </a>

        <h1 class="calendar-title">
            <i class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">calendar_view_month</i>
            Visualizzatore Calendari Camere
        </h1>

        <!-- Legenda generale -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <div class="calendar-legend">
                    <h5 style="color: #03a9f4; margin-bottom: 1rem;">
                        <i class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">info</i>
                        Legenda Colori
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="legend-item">
                                <div class="legend-color calendar1-color"></div>
                                <span>Calendario Primario</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="legend-item">
                                <div class="legend-color calendar2-color"></div>
                                <span>Calendario Secondario</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="legend-item">
                                <div class="legend-color overlap-color"></div>
                                <span>Sovrapposizione</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenitore per i calendari delle camere -->
        <div id="calendarsContainer">
            <div class="loading">
                <i class="material-icons" style="font-size: 3rem; display: block; margin-bottom: 1rem;">hourglass_empty</i>
                Caricamento calendari...
            </div>
        </div>
    </div>

    <!-- No external JS dependencies to avoid CSP issues -->

    <script>
        const roomNames = ['Villa Panorama', 'Calypso', 'Hermes', 'Elettra', 'Demetra', 'Iris Oasis'];
        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                           'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];

        let currentDate = new Date();
        let calendars = {};

        // Funzione per caricare i calendari
        async function loadCalendars() {
            const container = document.getElementById('calendarsContainer');
            container.innerHTML = '';

            try {
                for (const roomName of roomNames) {
                    // Crea la sezione per questa camera
                    const roomSection = document.createElement('div');
                    roomSection.className = 'room-section';
                    roomSection.innerHTML = `
                        <h3 class="room-title">
                            <i class="material-icons">hotel</i>
                            ${roomName}
                        </h3>
                        <div class="loading">
                            <i class="material-icons">hourglass_empty</i>
                            Caricamento eventi per ${roomName}...
                        </div>
                        <div id="calendar-${roomName.replace(/\s+/g, '')}" style="display: none;"></div>
                        <div id="agenda-button-container-${roomName.replace(/\s+/g, '')}" style="display: none; text-align: center; margin-top: 1rem;"></div>
                    `;
                    container.appendChild(roomSection);

                    // Carica i dati per questa camera
                    await loadRoomCalendar(roomName, roomSection);
                }
            } catch (error) {
                console.error('Errore nel caricamento dei calendari:', error);
                container.innerHTML = `
                    <div class="error">
                        <i class="material-icons" style="margin-right: 0.5rem;">error</i>
                        Errore nel caricamento dei calendari: ${error.message}
                    </div>
                `;
            }
        }

        // Funzione per caricare il calendario di una singola camera
        async function loadRoomCalendar(roomName, roomSection) {
            console.log(`Caricamento calendario per: ${roomName}`);

            try {
                const url = `/admin/calendar-events/${encodeURIComponent(roomName)}`;
                console.log(`Chiamata API: ${url}`);

                const response = await fetch(url);
                console.log(`Risposta API status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Errore API: ${response.status} - ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`Dati ricevuti per ${roomName}:`, data);

                // Nasconde il loading
                const loadingDiv = roomSection.querySelector('.loading');
                if (loadingDiv) {
                    console.log('Nascondendo loading...');
                    loadingDiv.style.display = 'none';
                }

                // Mostra il calendario e il bottone agenda
                const calendarDiv = roomSection.querySelector(`#calendar-${roomName.replace(/\s+/g, '')}`);
                const agendaContainer = roomSection.querySelector(`#agenda-button-container-${roomName.replace(/\s+/g, '')}`);

                if (calendarDiv && agendaContainer) {
                    console.log('Mostrando calendario e agenda...');
                    calendarDiv.style.display = 'block';
                    agendaContainer.style.display = 'block';

                    // Processa gli eventi per identificare sovrapposizioni
                    console.log(`Processando ${data.events ? data.events.length : 0} eventi...`);
                    const processedEvents = processEvents(data.events || []);
                    console.log(`Eventi processati: ${processedEvents.length}`);

                    // Crea il calendario personalizzato
                    createCustomCalendar(calendarDiv, processedEvents, roomName);

                    // Crea il bottone agenda
                    createAgendaButton(agendaContainer, processedEvents, roomName);
                } else {
                    console.error('Elementi DOM calendario non trovati:', {
                        calendarDiv: !!calendarDiv,
                        agendaContainer: !!agendaContainer
                    });
                }

            } catch (error) {
                console.error(`Errore nel caricamento del calendario per ${roomName}:`, error);
                const loadingDiv = roomSection.querySelector('.loading');
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div class="error">
                            <i class="material-icons" style="margin-right: 0.5rem;">error</i>
                            Errore nel caricamento di ${roomName}: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // Funzione per processare gli eventi e identificare sovrapposizioni
        function processEvents(events) {
            console.log('ProcessEvents input:', events);
            const processedEvents = [];

            // Prima aggiungi tutti gli eventi con i loro colori base
            events.forEach((event, index) => {
                console.log(`Processando evento ${index + 1}:`, event);

                // Debug: controlla i formati delle date
                console.log('Date evento:', {
                    start: event.start,
                    end: event.end,
                    startDateTime: event.start?.dateTime,
                    startDate: event.start?.date,
                    endDateTime: event.end?.dateTime,
                    endDate: event.end?.date
                });

                const startDate = new Date(event.start?.dateTime || event.start?.date || event.start);
                const endDate = new Date(event.end?.dateTime || event.end?.date || event.end);

                console.log('Date convertite:', {
                    startDate: startDate,
                    endDate: endDate,
                    startValid: !isNaN(startDate.getTime()),
                    endValid: !isNaN(endDate.getTime())
                });

                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    processedEvents.push({
                        id: event.id || `event-${index}`,
                        title: event.summary || 'Evento senza titolo',
                        start: startDate,
                        end: endDate,
                        className: event.calendarSource === 'calendar1' ? 'event-calendar1' : 'event-calendar2',
                        calendarSource: event.calendarSource === 'calendar1' ? 'Calendario Primario' : 'Calendario Secondario',
                        originalEvent: event
                    });
                    console.log(`Evento ${index + 1} aggiunto alla lista processata`);
                } else {
                    console.error(`Evento ${index + 1} ha date non valide, saltato`);
                }
            });

            console.log(`Eventi processati: ${processedEvents.length} su ${events.length} originali`);

            // Poi identifica sovrapposizioni e aggiorna i colori
            for (let i = 0; i < processedEvents.length; i++) {
                for (let j = i + 1; j < processedEvents.length; j++) {
                    const event1 = processedEvents[i];
                    const event2 = processedEvents[j];

                    // Controlla se si sovrappongono e sono di calendari diversi
                    if (event1.originalEvent.calendarSource !== event2.originalEvent.calendarSource) {
                        if (event1.start < event2.end && event2.start < event1.end) {
                            // Sovrapposizione trovata
                            event1.className = 'event-overlap';
                            event2.className = 'event-overlap';
                            event1.calendarSource += ' (Sovrapposizione!)';
                            event2.calendarSource += ' (Sovrapposizione!)';
                        }
                    }
                }
            }

            return processedEvents;
        }

        // Funzione per creare il calendario personalizzato
        function createCustomCalendar(container, events, roomName) {
            const calendar = document.createElement('div');
            calendar.className = 'custom-calendar';

            // Header del calendario
            const header = document.createElement('div');
            header.className = 'calendar-header';

            const nav = document.createElement('div');
            nav.className = 'calendar-nav';

            const prevBtn = document.createElement('button');
            prevBtn.className = 'nav-button';
            prevBtn.innerHTML = '‚Äπ Precedente';
            prevBtn.onclick = () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar(calendar, events, roomName);
            };

            const monthTitle = document.createElement('span');
            monthTitle.className = 'month-title';
            monthTitle.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            const nextBtn = document.createElement('button');
            nextBtn.className = 'nav-button';
            nextBtn.innerHTML = 'Successivo ‚Ä∫';
            nextBtn.onclick = () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar(calendar, events, roomName);
            };

            nav.appendChild(prevBtn);
            nav.appendChild(monthTitle);
            nav.appendChild(nextBtn);
            header.appendChild(nav);

            calendar.appendChild(header);

            // Grid del calendario
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            // Header giorni della settimana
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            calendar.appendChild(grid);
            container.appendChild(calendar);

            // Popola il calendario
            updateCalendar(calendar, events, roomName);
        }

        // Funzione per aggiornare il calendario
        function updateCalendar(calendar, events, roomName) {
            const grid = calendar.querySelector('.calendar-grid');
            const monthTitle = calendar.querySelector('.month-title');
            const today = new Date();

            // Aggiorna il titolo del mese
            monthTitle.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            // Rimuovi tutti i giorni esistenti (mantieni gli header)
            const dayHeaders = grid.querySelectorAll('.day-header');
            grid.innerHTML = '';
            dayHeaders.forEach(header => grid.appendChild(header));

            // Calcola i giorni del mese
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Crea i giorni del calendario
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);

                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';

                // Controlla se √® oggi
                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';

                const daySpan = document.createElement('span');
                daySpan.textContent = cellDate.getDate();
                dayNumber.appendChild(daySpan);

                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('day-other-month');
                }

                // Aggiungi eventi per questo giorno
                const dayEvents = events.filter(event => {
                    const eventStart = new Date(event.start);
                    const eventEnd = new Date(event.end);
                    return (eventStart.toDateString() === cellDate.toDateString()) ||
                           (eventStart <= cellDate && eventEnd > cellDate);
                });

                // Aggiungi contatore eventi se ce ne sono
                if (dayEvents.length > 0) {
                    dayCell.classList.add('has-events');
                    const eventsCount = document.createElement('div');
                    eventsCount.className = 'events-count';
                    eventsCount.textContent = dayEvents.length;
                    dayNumber.appendChild(eventsCount);
                }

                dayCell.appendChild(dayNumber);

                // Mostra massimo 3 eventi per giorno
                const maxVisibleEvents = 3;
                dayEvents.slice(0, maxVisibleEvents).forEach((event, index) => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `event-indicator ${event.className}`;
                    eventDiv.textContent = event.title.length > 15 ?
                                          event.title.substring(0, 12) + '...' :
                                          event.title;

                    // Aggiungi tooltip
                    eventDiv.addEventListener('mouseenter', (e) => {
                        showTooltip(e, event);
                    });

                    eventDiv.addEventListener('mouseleave', hideTooltip);

                    eventDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showEventDetails(event);
                    });

                    dayCell.appendChild(eventDiv);
                });

                // Se ci sono pi√π eventi, mostra "X altri"
                if (dayEvents.length > maxVisibleEvents) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'event-more';
                    moreDiv.textContent = `+${dayEvents.length - maxVisibleEvents} altri`;
                    moreDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showAllDayEvents(cellDate, dayEvents, roomName);
                    });
                    dayCell.appendChild(moreDiv);
                }

                grid.appendChild(dayCell);
            }
        }

        // Funzione per mostrare tooltip avanzato
        function showTooltip(e, event) {
            hideTooltip(); // Rimuovi tooltip esistenti

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';

            const duration = Math.round((event.end - event.start) / (1000 * 60 * 60 * 24));
            const startTime = event.start.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const endTime = event.end.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            tooltip.innerHTML = `
                <div class="tooltip-title">${event.title}</div>
                <div class="tooltip-source">${event.calendarSource}</div>
                <div class="tooltip-time">
                    <strong>Inizio:</strong> ${startTime}<br>
                    <strong>Fine:</strong> ${endTime}<br>
                    <strong>Durata:</strong> ${duration} ${duration === 1 ? 'giorno' : 'giorni'}
                </div>
            `;

            document.body.appendChild(tooltip);

            // Posiziona il tooltip in modo pi√π intelligente
            const rect = e.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 10;

            // Assicurati che il tooltip rimanga dentro la finestra
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 10;
            }

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;

            // Mostra il tooltip con animazione
            setTimeout(() => tooltip.classList.add('show'), 10);
        }

        // Funzione per nascondere tooltip
        function hideTooltip() {
            const tooltips = document.querySelectorAll('.tooltip');
            tooltips.forEach(tooltip => tooltip.remove());
        }

        // Funzione per mostrare dettagli evento in modal
        function showEventDetails(event) {
            // Crea un modal personalizzato invece di usare alert
            const modal = document.createElement('div');
            modal.className = 'event-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;

            const duration = Math.round((event.end - event.start) / (1000 * 60 * 60 * 24));
            const isOverlap = event.className === 'event-overlap';

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(145deg, #1f1f1f, #2a2a2a);
                    border-radius: 1rem;
                    padding: 2rem;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    border: 1px solid #444;
                    color: white;
                    position: relative;
                    transform: scale(0.9);
                    animation: modalSlideIn 0.3s ease forwards;
                ">
                    <button onclick="this.closest('.event-modal').remove()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: none;
                        border: none;
                        color: #ccc;
                        font-size: 1.5rem;
                        cursor: pointer;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s ease;
                    " onmouseover="this.style.backgroundColor='#444'" onmouseout="this.style.backgroundColor='transparent'">√ó</button>

                    ${isOverlap ? '<div style="color: #ffd93d; font-size: 2rem; text-align: center; margin-bottom: 1rem;">‚ö†Ô∏è</div>' : ''}

                    <h3 style="color: #03a9f4; margin-bottom: 1rem; font-size: 1.3rem;">${event.title}</h3>

                    <div style="background-color: #333; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #ffd93d; margin-right: 0.5rem;">üìç</span>
                            <strong>Fonte:</strong> <span style="color: ${isOverlap ? '#ffd93d' : '#4ecdc4'}; margin-left: 0.5rem;">${event.calendarSource}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #4caf50; margin-right: 0.5rem;">üïê</span>
                            <strong>Inizio:</strong> <span style="margin-left: 0.5rem;">${event.start.toLocaleString('it-IT')}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #f44336; margin-right: 0.5rem;">üïë</span>
                            <strong>Fine:</strong> <span style="margin-left: 0.5rem;">${event.end.toLocaleString('it-IT')}</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="color: #ff9800; margin-right: 0.5rem;">‚è∞</span>
                            <strong>Durata:</strong> <span style="margin-left: 0.5rem;">${duration} ${duration === 1 ? 'giorno' : 'giorni'}</span>
                        </div>
                    </div>

                    ${isOverlap ? `
                        <div style="
                            background: linear-gradient(135deg, #ffd93d, #f6c23e);
                            color: #000;
                            padding: 1rem;
                            border-radius: 0.5rem;
                            font-weight: 600;
                            text-align: center;
                        ">
                            ‚ö†Ô∏è ATTENZIONE: Questo evento si sovrappone con un altro calendario!
                        </div>
                    ` : ''}
                </div>
            `;

            // Aggiungi le animazioni CSS se non esistono gi√†
            if (!document.querySelector('#modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes modalSlideIn {
                        from { transform: scale(0.9) translateY(-20px); opacity: 0; }
                        to { transform: scale(1) translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(modal);

            // Chiudi il modal cliccando fuori
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Funzione per mostrare tutti gli eventi del giorno
        function showAllDayEvents(date, events, roomName) {
            const eventsList = events.map(event =>
                `‚Ä¢ ${event.title} (${event.calendarSource})`
            ).join('\n');

            alert(`üìÖ Eventi per ${date.toLocaleDateString('it-IT')} - ${roomName}\n\n${eventsList}`);
        }

        // Funzione per creare il bottone agenda
        function createAgendaButton(container, events, roomName) {
            const agendaButton = document.createElement('button');
            agendaButton.className = 'btn btn-agenda';
            agendaButton.innerHTML = `
                <i class="material-icons" style="margin-right: 0.5rem;">list</i>
                Visualizza Agenda (${events.length} eventi)
            `;

            // Stile del bottone
            agendaButton.style.cssText = `
                background: linear-gradient(135deg, #03a9f4, #0288d1);
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(3, 169, 244, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto;
            `;

            // Effetti hover
            agendaButton.addEventListener('mouseenter', () => {
                agendaButton.style.background = 'linear-gradient(135deg, #0288d1, #0277bd)';
                agendaButton.style.transform = 'translateY(-1px)';
                agendaButton.style.boxShadow = '0 4px 12px rgba(3, 169, 244, 0.4)';
            });

            agendaButton.addEventListener('mouseleave', () => {
                agendaButton.style.background = 'linear-gradient(135deg, #03a9f4, #0288d1)';
                agendaButton.style.transform = 'translateY(0)';
                agendaButton.style.boxShadow = '0 2px 8px rgba(3, 169, 244, 0.3)';
            });

            // Click handler per mostrare l'agenda
            agendaButton.addEventListener('click', () => {
                showAgendaModal(events, roomName);
            });

            container.appendChild(agendaButton);
        }

        // Funzione per mostrare l'agenda in un modal
        function showAgendaModal(events, roomName) {
            const modal = document.createElement('div');
            modal.className = 'agenda-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;

            // Ordina gli eventi per data
            const sortedEvents = events.sort((a, b) => new Date(a.start) - new Date(b.start));

            modal.innerHTML = `
                <div style="
                    background: linear-gradient(145deg, #1f1f1f, #2a2a2a);
                    border-radius: 1rem;
                    padding: 2rem;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    border: 1px solid #444;
                    color: white;
                    position: relative;
                    transform: scale(0.9);
                    animation: modalSlideIn 0.3s ease forwards;
                ">
                    <button onclick="this.closest('.agenda-modal').remove()" style="
                        position: absolute;
                        top: 1rem;
                        right: 1rem;
                        background: none;
                        border: none;
                        color: #ccc;
                        font-size: 1.5rem;
                        cursor: pointer;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s ease;
                    " onmouseover="this.style.backgroundColor='#444'" onmouseout="this.style.backgroundColor='transparent'">√ó</button>

                    <div style="display: flex; align-items: center; margin-bottom: 2rem;">
                        <i class="material-icons" style="font-size: 2rem; color: #03a9f4; margin-right: 1rem;">list</i>
                        <div>
                            <h3 style="color: #03a9f4; margin: 0; font-size: 1.5rem;">Agenda - ${roomName}</h3>
                            <p style="color: #ccc; margin: 0.25rem 0 0 0; font-size: 0.9rem;">${sortedEvents.length} eventi trovati</p>
                        </div>
                    </div>

                    ${sortedEvents.length === 0 ? `
                        <div style="
                            text-align: center;
                            padding: 3rem 1rem;
                            color: #666;
                            font-size: 1.1rem;
                        ">
                            <i class="material-icons" style="font-size: 3rem; margin-bottom: 1rem; color: #555;">event_note</i><br>
                            Nessun evento trovato per questo periodo
                        </div>
                    ` : sortedEvents.map(event => {
                        const duration = Math.round((event.end - event.start) / (1000 * 60 * 60 * 24));
                        const isOverlap = event.className === 'event-overlap';
                        const eventColor = event.className === 'event-calendar1' ? '#ff6b6b' :
                                         event.className === 'event-calendar2' ? '#4ecdc4' : '#ffd93d';
                        const eventIcon = event.className === 'event-calendar1' ? '‚óè' :
                                        event.className === 'event-calendar2' ? '‚ñ≤' : '‚ö†';

                        return `
                            <div style="
                                background-color: #333;
                                border-radius: 0.75rem;
                                padding: 1.5rem;
                                margin-bottom: 1rem;
                                border-left: 4px solid ${eventColor};
                                transition: transform 0.2s ease;
                                cursor: pointer;
                                ${isOverlap ? 'box-shadow: 0 0 0 1px #ffd93d;' : ''}
                            " onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.75rem;">
                                    <h4 style="color: #fff; margin: 0; font-size: 1.1rem; flex: 1;">
                                        <span style="color: ${eventColor}; margin-right: 0.5rem;">${eventIcon}</span>
                                        ${event.title}
                                    </h4>
                                    ${isOverlap ? '<span style="color: #ffd93d; font-size: 1.2rem;">‚ö†Ô∏è</span>' : ''}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.85rem; color: #ccc;">
                                    <div>
                                        <div style="margin-bottom: 0.5rem;">
                                            <span style="color: #4caf50; margin-right: 0.25rem;">‚ñ∂</span>
                                            <strong>Inizio:</strong><br>
                                            <span style="margin-left: 1rem;">${event.start.toLocaleString('it-IT')}</span>
                                        </div>
                                        <div>
                                            <span style="color: #f44336; margin-right: 0.25rem;">‚ñ†</span>
                                            <strong>Fine:</strong><br>
                                            <span style="margin-left: 1rem;">${event.end.toLocaleString('it-IT')}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="margin-bottom: 0.5rem;">
                                            <span style="color: #ff9800; margin-right: 0.25rem;">‚è∞</span>
                                            <strong>Durata:</strong><br>
                                            <span style="margin-left: 1rem;">${duration} ${duration === 1 ? 'giorno' : 'giorni'}</span>
                                        </div>
                                        <div>
                                            <span style="color: ${eventColor}; margin-right: 0.25rem;">üìç</span>
                                            <strong>Fonte:</strong><br>
                                            <span style="margin-left: 1rem; color: ${eventColor};">${event.calendarSource}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(modal);

            // Chiudi il modal cliccando fuori
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Aggiungi supporto per ESC
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Carica i calendari quando la pagina √® pronta
        document.addEventListener('DOMContentLoaded', loadCalendars);
    </script>
</body>
</html>